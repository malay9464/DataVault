<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard — Data Vault</title>
    <link rel="stylesheet" href="/static/css/upload.css">
    <link rel="stylesheet" href="/static/css/dashboard.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
</head>
<body>

<!-- HEADER — identical to upload.html -->
<div class="top-header">
    <span style="letter-spacing:0.3px;">
        <svg class="header-icon" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
        </svg>
        Data Vault
    </span>
    <div class="header-actions">
        <button class="logout-btn" onclick="logout()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4M16 17l5-5-5-5M21 12H9"/>
            </svg>
            Logout
        </button>
    </div>
</div>

<!-- SIDEBAR — mirrors upload.html exactly -->
<div class="sidebar">
    <div class="sidebar-top">

        <!-- Dashboard — active/highlighted -->
        <div class="category active" style="background:rgba(99,102,241,0.25); cursor:default;">
            <span>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/>
                    <rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/>
                </svg>
                Dashboard
            </span>
        </div>

        <!-- All Files -->
        <div class="category" onclick="location.href='/'">
            <span>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/>
                </svg>
                All Files
            </span>
        </div>

        <hr>
        <h3>Users</h3>
    </div>

    <!-- Scrollable user list — mirrors category list pattern -->
    <div class="sidebar-scroll" id="userList">
        <div class="sidebar-loading" style="padding:12px 16px; font-size:12px; color:#94a3b8;">Loading users...</div>
    </div>

    <div class="sidebar-bottom">
        <hr>
        <div onclick="openAddUserModal()" class="new-category-btn">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                <circle cx="8.5" cy="7" r="4"/>
                <line x1="20" y1="8" x2="20" y2="14"/>
                <line x1="23" y1="11" x2="17" y2="11"/>
            </svg>
            Add User
        </div>
        <div onclick="location.href='/users.html'" class="new-category-btn" style="margin-top:4px;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                <circle cx="9" cy="7" r="4"/>
                <path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/>
            </svg>
            Manage Users
        </div>
    </div>
</div>

<!-- ADD USER MODAL -->
<div id="addUserModal" class="modal-overlay" style="display:none;">
    <div class="modal-box">
        <div class="modal-header">
            <h3>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                    <circle cx="8.5" cy="7" r="4"/>
                    <line x1="20" y1="8" x2="20" y2="14"/>
                    <line x1="23" y1="11" x2="17" y2="11"/>
                </svg>
                Add User
            </h3>
            <span class="modal-close" onclick="closeAddUserModal()">×</span>
        </div>
        <div class="modal-body">
            <div class="input-group">
                <label>Email Address</label>
                <input type="email" id="newUserEmail" placeholder="user@example.com">
            </div>
            <div class="input-group">
                <label>Password</label>
                <input type="password" id="newUserPassword" placeholder="Enter password">
            </div>
            <div class="input-group">
                <label>Role</label>
                <div class="role-selector">
                    <label class="radio-option">
                        <input type="radio" name="userRole" value="user" checked>
                        <div class="radio-card">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/>
                                <circle cx="12" cy="7" r="4"/>
                            </svg>
                            <strong>User</strong>
                            <span>Standard access</span>
                        </div>
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="userRole" value="admin">
                        <div class="radio-card">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                            </svg>
                            <strong>Admin</strong>
                            <span>Full control</span>
                        </div>
                    </label>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="closeAddUserModal()">Cancel</button>
            <button class="btn-primary" onclick="createUser()">Add User</button>
        </div>
    </div>
</div>

<!-- MAIN CONTENT -->
<div class="main">
    <div class="content-box">

        <!-- PAGE TITLE -->
        <div class="page-header">
            <div>
                <h1 class="page-title">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/>
                        <rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/>
                    </svg>
                    Admin Dashboard
                </h1>
                <p class="page-subtitle">Platform overview and analytics</p>
            </div>
            <div class="period-selector">
                <button class="period-btn active" data-days="7" onclick="setPeriod(7, this)">7d</button>
                <button class="period-btn" data-days="30" onclick="setPeriod(30, this)">30d</button>
                <button class="period-btn" data-days="90" onclick="setPeriod(90, this)">90d</button>
            </div>
        </div>

        <!-- ROW 1: STAT CARDS -->
        <div class="stat-grid">
            <div class="stat-card">
                <div class="stat-icon stat-icon--blue">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/>
                    </svg>
                </div>
                <div class="stat-body">
                    <div class="stat-label">Total Users</div>
                    <div class="stat-value" id="stat-total-users">—</div>
                    <div class="stat-sub" id="stat-users-sub">— active · — disabled</div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon stat-icon--green">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/>
                    </svg>
                </div>
                <div class="stat-body">
                    <div class="stat-label">Total Files</div>
                    <div class="stat-value" id="stat-total-files">—</div>
                    <div class="stat-sub" id="stat-files-sub">— processing · — failed</div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon stat-icon--purple">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/>
                        <line x1="6" y1="20" x2="6" y2="14"/>
                    </svg>
                </div>
                <div class="stat-body">
                    <div class="stat-label">Total Records</div>
                    <div class="stat-value" id="stat-total-records">—</div>
                    <div class="stat-sub" id="stat-records-sub">across all uploads</div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon stat-icon--orange">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                    </svg>
                </div>
                <div class="stat-body">
                    <div class="stat-label">Storage Health</div>
                    <div class="stat-value" id="stat-health">—</div>
                    <div class="stat-sub" id="stat-health-sub">orphaned rows in DB</div>
                </div>
            </div>
        </div>

        <!-- ROW 2: ACTIVITY CHART -->
        <div class="chart-row">
            <div class="chart-card chart-card--full">
                <div class="chart-header">
                    <div>
                        <div class="chart-title">Upload Activity</div>
                        <div class="chart-subtitle">Files uploaded and records processed over time</div>
                    </div>
                    <div class="chart-legend">
                        <span class="legend-dot legend-dot--blue"></span><span>Files</span>
                        <span class="legend-dot legend-dot--green"></span><span>Records (k)</span>
                    </div>
                </div>
                <div class="chart-body">
                    <canvas id="activityChart"></canvas>
                </div>
            </div>
        </div>

        <!-- ROW 3: USER BREAKDOWN -->
        <div class="chart-row chart-row--half">
            <div class="chart-card">
                <div class="chart-header">
                    <div>
                        <div class="chart-title">Top Users by Files</div>
                        <div class="chart-subtitle">Most active uploaders</div>
                    </div>
                </div>
                <div class="chart-body">
                    <canvas id="topUsersFilesChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <div class="chart-header">
                    <div>
                        <div class="chart-title">Top Users by Records</div>
                        <div class="chart-subtitle">By total record volume</div>
                    </div>
                </div>
                <div class="chart-body">
                    <canvas id="topUsersRecordsChart"></canvas>
                </div>
            </div>
        </div>

        <!-- ROW 4: DATA QUALITY -->
        <div class="chart-row chart-row--third">
            <div class="chart-card">
                <div class="chart-header">
                    <div>
                        <div class="chart-title">Duplicate Rate by User</div>
                        <div class="chart-subtitle">Avg % duplicates per upload</div>
                    </div>
                </div>
                <div class="chart-body">
                    <canvas id="dupRateChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <div class="chart-header">
                    <div>
                        <div class="chart-title">File Types</div>
                        <div class="chart-subtitle">CSV vs Excel breakdown</div>
                    </div>
                </div>
                <div class="chart-body chart-body--donut">
                    <canvas id="fileTypeChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <div class="chart-header">
                    <div>
                        <div class="chart-title">Processing Status</div>
                        <div class="chart-subtitle">Current file states</div>
                    </div>
                </div>
                <div class="chart-body chart-body--donut">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
        </div>

        <!-- ROW 5: RECENT ACTIVITY FEED -->
        <div class="feed-card">
            <div class="chart-header">
                <div>
                    <div class="chart-title">Recent Activity</div>
                    <div class="chart-subtitle">Last 10 uploads across all users</div>
                </div>
                <button class="refresh-btn" onclick="loadDashboard()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="23 4 23 10 17 10"/>
                        <path d="M20.49 15a9 9 0 11-2.12-9.36L23 10"/>
                    </svg>
                    Refresh
                </button>
            </div>
            <div class="feed-table-wrapper">
                <table class="feed-table">
                    <thead>
                        <tr>
                            <th>File</th>
                            <th>User</th>
                            <th>Category</th>
                            <th>Records</th>
                            <th>Duplicates</th>
                            <th>Status</th>
                            <th>Uploaded</th>
                        </tr>
                    </thead>
                    <tbody id="feedBody">
                        <tr><td colspan="7" class="feed-loading">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>
</div>

<div id="toastContainer"></div>

<script>
// ── Auth guard — redirect non-admins away ──────────────────────────────────
(function() {
    const token = localStorage.getItem('token');
    if (!token) { location.href = '/login.html'; return; }
    try {
        const payload = JSON.parse(atob(token.split('.')[1]));
        if (payload.role !== 'admin') { location.href = '/'; }
    } catch(e) { location.href = '/login.html'; }
})();

// ── Shared utilities ───────────────────────────────────────────────────────
function getToken() { return localStorage.getItem('token'); }

function logout() {
    localStorage.removeItem('token');
    location.href = '/login.html';
}

function showToast(msg, type = 'success') {
    const t = document.createElement('div');
    t.className = `toast toast--${type}`;
    t.textContent = msg;
    document.getElementById('toastContainer').appendChild(t);
    setTimeout(() => t.remove(), 3500);
}

// ── Add User modal (same as upload.html) ──────────────────────────────────
function openAddUserModal() {
    document.getElementById('addUserModal').style.display = 'flex';
}
function closeAddUserModal() {
    document.getElementById('addUserModal').style.display = 'none';
    document.getElementById('newUserEmail').value = '';
    document.getElementById('newUserPassword').value = '';
}
async function createUser() {
    const email    = document.getElementById('newUserEmail').value.trim();
    const password = document.getElementById('newUserPassword').value.trim();
    const role     = document.querySelector('input[name="userRole"]:checked').value;
    if (!email || !password) { showToast('Email and password required', 'error'); return; }
    try {
        const r = await fetch(`/admin/users?email=${encodeURIComponent(email)}&password=${encodeURIComponent(password)}&role=${role}`, {
            method: 'POST',
            headers: { Authorization: `Bearer ${getToken()}` }
        });
        if (!r.ok) { const d = await r.json(); showToast(d.detail || 'Failed', 'error'); return; }
        showToast('User created successfully');
        closeAddUserModal();
        loadUserList();
    } catch(e) { showToast('Network error', 'error'); }
}

// ── Sidebar user list ──────────────────────────────────────────────────────
async function loadUserList() {
    try {
        const r = await fetch('/admin/users-with-stats', {
            headers: { Authorization: `Bearer ${getToken()}` }
        });
        const users = await r.json();
        const list = document.getElementById('userList');
        const regularUsers = users.filter(u => u.role !== 'admin');
        if (!regularUsers.length) {
            list.innerHTML = '<div style="padding:12px 16px; font-size:12px; color:#94a3b8;">No users yet</div>';
            return;
        }
        list.innerHTML = regularUsers.map(u => `
            <div class="category" onclick="filterByUser(${u.id})" title="${u.email}">
                <span style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:140px;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="flex-shrink:0;">
                        <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/>
                    </svg>
                    ${u.email.split('@')[0]}
                </span>
                <span class="count-badge">${u.upload_count}</span>
            </div>
        `).join('');
    } catch(e) { console.error('Could not load user list', e); }
}

function filterByUser(userId) {
    // Highlight selected user in sidebar
    document.querySelectorAll('#userList .category').forEach(el => el.classList.remove('active'));
    event.currentTarget.classList.add('active');
    // Scroll feed to top and re-render filtered (future enhancement)
    // For now, scroll to recent activity
    document.querySelector('.feed-card').scrollIntoView({ behavior: 'smooth' });
}

// ── Dashboard JS (unchanged from original) ────────────────────────────────
</script>

<script src="/static/js/dashboard.js"></script>
</body>
</html>